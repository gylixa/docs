Формы в Django
^^^^^^^^^^^^^^^

Основные концепции
===================

Формы в Django используются для:
- Сбора пользовательского ввода через HTML-формы
- Валидации и очистки данных
- Преобразования данных в Python-типы
- Генерации HTML-разметки форм

1. Создание простой формы
-------------------------

.. code-block:: python
   :linenos:

   from django import forms
   
   class ContactForm(forms.Form):
       name = forms.CharField(max_length=100)
       email = forms.EmailField()
       message = forms.CharField(widget=forms.Textarea)

**Объяснение:** Класс ``forms.Form`` создает независимую форму. ``CharField``, ``EmailField`` - типы полей с базовой валидацией.

2. ModelForm - формы на основе моделей
--------------------------------------

.. code-block:: python
   :linenos:

   from django import forms
   from .models import Article
   
   class ArticleForm(forms.ModelForm):
       class Meta:
           model = Article
           fields = ['title', 'content', 'author']

**Объяснение:** ``ModelForm`` автоматически создает поля на основе модели. Класс ``Meta`` определяет связанную модель и отображаемые поля.

3. Типы полей форм
------------------

.. code-block:: python
   :linenos:

   class ExampleForm(forms.Form):
       text = forms.CharField(max_length=100)
       email = forms.EmailField()
       date = forms.DateField(widget=forms.SelectDateWidget())
       choice = forms.ChoiceField(choices=[('A', 'Option A'), ('B', 'Option B')])
       boolean = forms.BooleanField(required=False)

**Объяснение:** Django предоставляет различные типы полей: ``CharField`` (текст), ``EmailField`` (email с валидацией), ``DateField`` (дата), ``ChoiceField`` (выбор из списка), ``BooleanField`` (чекбокс).

4. Виджеты (Widgets)
--------------------

.. code-block:: python
   :linenos:

   class UserForm(forms.Form):
       username = forms.CharField(widget=forms.TextInput(attrs={
           'class': 'form-control',
           'placeholder': 'Enter username'
       }))
       password = forms.CharField(widget=forms.PasswordInput())
       bio = forms.CharField(widget=forms.Textarea(attrs={'rows': 3}))

**Объяснение:** Виджеты определяют HTML-представление поля. ``attrs`` позволяет добавлять HTML-атрибуты (классы, placeholder).

5. Валидация данных
-------------------

.. code-block:: python
   :linenos:

   class RegistrationForm(forms.Form):
       username = forms.CharField(min_length=3, max_length=20)
       
       def clean_username(self):
           username = self.cleaned_data['username']
           if User.objects.filter(username=username).exists():
               raise forms.ValidationError("Username already exists")
           return username
       
       def clean(self):
           cleaned_data = super().clean()
           # Дополнительная проверка всех полей
           return cleaned_data

**Объяснение:** ``clean_<fieldname>()`` валидирует конкретное поле. ``clean()`` проверяет всю форму. ``cleaned_data`` содержит проверенные данные.

6. Обработка в представлении (View)
-----------------------------------

.. code-block:: python
   :linenos:

   def contact_view(request):
       if request.method == 'POST':
           form = ContactForm(request.POST)
           if form.is_valid():
               # Обработка валидных данных
               name = form.cleaned_data['name']
               send_email(name)
               return redirect('success')
       else:
           form = ContactForm()
       
       return render(request, 'contact.html', {'form': form})

**Объяснение:** В POST-запросе форма заполняется данными и валидируется. ``is_valid()`` проверяет все правила. ``cleaned_data`` доступен после успешной валидации.

7. Отображение в шаблоне
------------------------

.. code-block:: django
   :linenos:

   <!-- Автоматическая генерация всей формы -->
   {{ form.as_p }}
   
   <!-- Ручное отображение -->
   <form method="post">
       {% csrf_token %}
       {{ form.non_field_errors }}
       
       <div>
           {{ form.name.label_tag }}
           {{ form.name }}
           {{ form.name.errors }}
       </div>
       
       <button type="submit">Submit</button>
   </form>

**Объяснение:** ``as_p``, ``as_table``, ``as_ul`` - методы автоматической генерации HTML. Ручное отображение дает больше контроля над разметкой. ``csrf_token`` обязателен для POST-запросов.

8. Начальные значения (initial data)
-------------------------------------

.. code-block:: python
   :linenos:

   # В представлении
   form = ContactForm(initial={
       'name': request.user.get_full_name(),
       'email': request.user.email
   })
   
   # Или при создании поля
   class ContactForm(forms.Form):
       name = forms.CharField(initial='Guest')

**Объяснение:** ``initial`` устанавливает начальные значения полей формы, полезно для предзаполнения данных.

9. File Upload формы
---------------------

.. code-block:: python
   :linenos:

   class UploadForm(forms.Form):
       file = forms.FileField()
       image = forms.ImageField()
   
   # В представлении
   def upload_view(request):
       if request.method == 'POST':
           form = UploadForm(request.POST, request.FILES)
           if form.is_valid():
               handle_uploaded_file(request.FILES['file'])

**Объяснение:** Для загрузки файлов нужен ``enctype="multipart/form-data"`` в HTML-форме и ``request.FILES`` в представлении.

10. Формы в админке Django
--------------------------

.. code-block:: python
   :linenos:

   from django.contrib import admin
   
   class ArticleAdmin(admin.ModelAdmin):
       form = ArticleForm
       list_display = ['title', 'author', 'created_at']
   
   admin.site.register(Article, ArticleAdmin)

**Объяснение:** Кастомные формы могут использоваться в административной панели Django через атрибут ``form`` в ``ModelAdmin``.

Лучшие практики
===============

1. **Используйте ModelForm** когда форма напрямую связана с моделью
2. **Добавляйте CSS-классы** через виджеты для стилизации
3. **Всегда проверяйте** ``form.is_valid()`` перед использованием данных
4. **Используйте кастомную валидацию** для бизнес-логики
5. **Обрабатывайте ошибки** в шаблонах для UX
6. **Защищайте от CSRF** с помощью ``{% csrf_token %}``
7. **Для файлов** используйте ``multipart/form-data`` и ``request.FILES``
8. **Тестируйте формы** с различными входными данными

Связь с HTML
============

.. code-block:: html

   <!-- HTML-форма, генерируемая Django -->
   <form action="/submit/" method="post" enctype="multipart/form-data">
       <input type="text" name="username" id="id_username">
       <input type="email" name="email" id="id_email">
       <textarea name="message" id="id_message"></textarea>
   </form>

**Объяснение:** Django автоматически генерирует HTML с уникальными ``id`` (id_<fieldname>) и ``name`` атрибутами, соответствующими именам полей формы.